name: ğŸš€ CESIZen CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ§ª Tests & Build
  test:
    runs-on: ubuntu-latest
    name: ğŸ” Tests et Build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”¨ Build application
      run: npm run build
      
    - name: ğŸ§ª Run tests
      run: npm run test:run
      
    - name: ğŸ“ Run linting
      run: npm run lint

  # ğŸ›¡ï¸ Security Tests
  security:
    runs-on: ubuntu-latest
    name: ğŸ›¡ï¸ Tests SÃ©curitÃ©
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ï¿½ Start application in background
      run: npm run build && npm start &
      
    - name: â³ Wait for app to be ready
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… App is ready!"
            break
          fi
          echo "â³ Waiting for app... ($i/30)"
          sleep 2
        done
      
    - name: ï¿½ğŸ›¡ï¸ Run Security Tests
      run: npm run security-test
      continue-on-error: true
      
    - name: ğŸ“Š Security Test Results
      run: echo "ğŸ›¡ï¸ Security tests completed! Check logs above for details."

  # ğŸš€ Deploy Ready
  deploy-ready:
    runs-on: ubuntu-latest
    name: âœ… Ready to Deploy
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ‰ Deployment Ready
      run: |
        echo "ğŸ¯ All checks passed!"
        echo "ğŸš€ Application is ready for deployment!"
        echo "ğŸ“‹ Summary:"
        echo "  âœ… Tests passed"
        echo "  âœ… Build successful"
        echo "  âœ… Security tests completed"
